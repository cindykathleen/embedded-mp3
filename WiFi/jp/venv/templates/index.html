<!DOCTYPE HTML>
<html>

<head>
    <!-- Jquery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.3/css/bootstrap.min.css" integrity="sha384-Zug+QiDoJOrZ5t4lssLdxGhVrurbmBWopoEl+M6BdEfwnCJZtKxi1KgxUyJq13dy" crossorigin="anonymous">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.3/js/bootstrap.min.js" integrity="sha384-a5N7Y/aK3qNeh15eJKGWxsqtnX/wWdSZSKp+81YjTmS15nvnvxKHuzaWwXHDli+4" crossorigin="anonymous"></script>
    <!-- My scripts -->
    <script type=text/javascript>
      $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
    </script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300" rel="stylesheet">

    <style>
        #mid {
            position: relative;
            top: 50%;
            transform: translateY(-50%);
        }
    </style>
</head>

<body>

    <br><br><br>

    <!-- Title -->
    <div class="row">
        <div class="col-3"></div>
        <div class="col-6">
            <div class="card">
                <div class="card-header" align="center">
                    <h1 style="font-family: 'Open Sans', sans-serif;"> 
                        MP3 Player 
                    </h1>
                </div>
                <div class="card-block" style="height:200px;">
                    <div id="mid" align="center">
                        <button id="Play"  type="button" class="btn btn-dark"> Play  </button>
                        <button id="Pause" type="button" class="btn btn-dark"> Pause </button>
                        <button id="Stop"  type="button" class="btn btn-dark"> Stop  </button>
                        <button id="Prev"  type="button" class="btn btn-dark"> Prev  </button>
                        <button id="Next"  type="button" class="btn btn-dark"> Next  </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-3"></div>
    </div>

    <br><br><br>


    <div id="terminal" align="center" style="box-sizing: border-box;">
    </div>

    <script>

        // Buttons dictionary
        // TODO : Maybe just remove this middleman var
        var buttons = {
            PLAY  : "PACKET_OPCODE_SET_PLAY_CURRENT",
            PAUSE : "PACKET_OPCODE_SET_PAUSE",
            STOP  : "PACKET_OPCODE_SET_STOP",
            PREV  : "PACKET_OPCODE_SET_PLAY_PREV",
            NEXT  : "PACKET_OPCODE_SET_PLAY_NEXT",
        };

        function read_diagnostic_packet() {

            // $.ajax({
            //     type    : "GET",
            //     url     : "/diagnostic_status"
            //     success :
            //     error   :
            // })

            $.getJSON("/diagnostic_status", function(data) {
                var new_div = document.createElement('div');
                new_div.innerHTML = data;
                $("#terminal").append(new_div);
            });

        }

        // Function to call Flask callback
        function send_command_packet(button) {

            if (buttons.hasOwnProperty(button)) {
                $.ajax({
                    type    : "POST",
                    url     : "/command/" + buttons[button],
                    success : function(data, status, request) {
                                status_url = request.getResponseHeader("Location");
                                update_terminal(status_url, 0);
                            },
                    error   : function() {
                                alert("Unexpected error???");
                            }
                });
            }
            else {
                console.log("Invalid button received:", button);
            }
        }

        // Function to create div
        function update_terminal(status_url, elapsed) {

            $.getJSON(status_url, function(data) {
                switch (data['state']) 
                {
                    case "DONE":
                        var div = $('<div></div>');
                        var status = data['status'];
                        div.innerHTML = status;
                        $("#terminal").append(div);
                        console.log(status);
                        break;
                    case "TIMED_OUT":
                        console.log("Timed out");
                        break;
                    case "STANDBY": 
                        // No break
                    case "CONNECTING":
                        console.log("Elapsed:", elapsed, "Restarting in 2 seconds...");
                        setTimeout(function() {
                            update_terminal(status_url, elapsed + 2);
                        }, 2000);
                        break;
                    default:
                        console.log("Invalid state:", data['state']);
                        break;
                }
            });
        }

        // On click call update
        $("button#Play").bind("click",  function() { send_command_packet("PLAY");  });
        $("button#Pause").bind("click", function() { send_command_packet("PAUSE"); });
        $("button#Stop").bind("click",  function() { send_command_packet("STOP");  });
        $("button#Prev").bind("click",  function() { send_command_packet("PREV");  });
        $("button#Next").bind("click",  function() { read_diagnostic_packet(); });
        //{ send_command_packet("NEXT");  });

    </script>

</body>

</html>