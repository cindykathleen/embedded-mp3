<!DOCTYPE HTML>
<html>

<head>
    <!-- Jquery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <!-- Material CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/css/materialize.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/js/materialize.min.js"></script>

    <!-- My scripts -->
    <script type=text/javascript>
      $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
    </script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300" rel="stylesheet">

    <style>
        #mid {
            position: relative;
            top: 50%;
            transform: translateY(-50%);
        }
        .terminal_row_10 {
            width: 10%;
            text-align:center;
        }
        .terminal_row_20 {
            width: 20%;
            text-align:center;
        }
        .terminal_row_25 {
            width: 25%;
            text-align:center;
        }
        .terminal_row_33 {
            width: 33.33%;
            text-align:center;
        }
        .terminal_row_60 {
            width: 60%;
            text-align:center;
        }
        .mid-button {
            margin-left : auto;
            margin-right: auto;
        }
        .button-row {
            width   : 100%;
            height  : 33.33%;
            /*display : inline-block;*/
        }
    </style>
</head>

<body>

    <br><br><br>

    <div class="container">
        <div class="row">
            <div class="card" style="width:100%">
                <div class="card-title" align="center">
                    <h1 style="font-family: 'Open Sans', sans-serif;"> 
                        MP3 Player 
                    </h1>
                </div>
                <div class="card-content" style="height:300px;">
                    <div class="center-align button-row">
                        <a id="Play"  class="waves-effect btn mid-button"> Play  </a>
                        <a id="Pause" class="waves-effect btn mid-button"> Pause </a>
                        <a id="Stop"  class="waves-effect btn mid-button"> Stop  </a>
                        <a id="Prev"  class="waves-effect btn mid-button"> Prev  </a>
                        <a id="Next"  class="waves-effect btn mid-button"> Next  </a>
                    </div>
                    <div class="center-align button-row">
                        <a id="" class="waves-effect btn mid-button"> Get Status       </a>
                        <a id="" class="waves-effect btn mid-button"> Get Sample Rate  </a>
                        <a id="" class="waves-effect btn mid-button"> Get Decode Time  </a>
                    </div>
                    <div class="center-align button-row">
                        <a id="" class="waves-effect btn mid-button"> Get Header Info  </a>
                        <a id="" class="waves-effect btn mid-button"> Bit Rate         </a>
                        <a id="" class="waves-effect btn mid-button"> Reset            </a>
                    </div>
                </div>

<!--                 <input type="range" min="1" max="100" step="1" value="15">
                <form action="#">
                    <p class="range-field">
                      <input type="range" id="test5" min="0" max="100" />
                    </p>
                </form>
 -->        </div>
        </div>
    </div>

    <br><br><br>


    <div class="container">
        <div class="row">
            <div style="width:100%; overflow: auto; height:500px">
                <table class="centered highlight" style="width:100%; font-family: 'Open Sans', sans-serif;">
                    <thead>
                        <tr>
                            <th class="col terminal_row_10">Time</th>
                            <th class="col terminal_row_10">Count</th>
                            <th class="col terminal_row_60">Message</th>
                            <th class="col terminal_row_20">Status</th>
                        </tr>
                    </thead>
                    <tbody id="terminal">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>

        // Buttons dictionary
        // TODO : Maybe just remove this middleman var
        var buttons = {
            PLAY  : "PACKET_OPCODE_SET_PLAY_CURRENT",
            PAUSE : "PACKET_OPCODE_SET_PAUSE",
            STOP  : "PACKET_OPCODE_SET_STOP",
            PREV  : "PACKET_OPCODE_SET_PLAY_PREV",
            NEXT  : "PACKET_OPCODE_SET_PLAY_NEXT",
        };

        function read_diagnostic_packet() {

            // $.ajax({
            //     type    : "GET",
            //     url     : "/diagnostic_status"
            //     success :
            //     error   :
            // })

            $.getJSON("/diagnostic_status", function(data) {

                // If exception status then skip

                var date = new Date();

                var new_row = document.createElement("tr");

                var new_col1 = document.createElement("th");
                var new_col2 = document.createElement("th");
                var new_col3 = document.createElement("th");
                var new_col4 = document.createElement("th");

                new_col1.className = "col terminal_row_10";
                new_col2.className = "col terminal_row_10";
                new_col3.className = "col terminal_row_60";
                new_col4.className = "col terminal_row_20";

                new_col1.innerHTML = date.getHours() + ":" + date.getMinutes();
                new_col2.innerHTML = data["count"];
                new_col3.innerHTML = data["message"];
                new_col4.innerHTML = data["status"];

                new_row.appendChild(new_col1);
                new_row.appendChild(new_col2);
                new_row.appendChild(new_col3);
                new_row.appendChild(new_col4);

                console.log(data);
                console.log(new_row);
                $("#terminal").append(new_row);
            });

        }

        // Function to call Flask callback
        function send_command_packet(button) {

            if (buttons.hasOwnProperty(button)) {
                $.ajax({
                    type    : "POST",
                    url     : "/command/" + buttons[button],
                    success : function(data, status, request) {
                                status_url = request.getResponseHeader("Location");
                                update_terminal(status_url, 0);
                            },
                    error   : function() {
                                alert("Unexpected error???");
                            }
                });
            }
            else {
                console.log("Invalid button received:", button);
            }
        }

        // Function to create div
        function update_terminal(status_url, elapsed) {

            $.getJSON(status_url, function(data) {
                switch (data['state']) 
                {
                    case "DONE":
                        var div = $('<div></div>');
                        var status = data['status'];
                        div.innerHTML = status;
                        $("#terminal").append(div);
                        console.log(status);
                        break;
                    case "TIMED_OUT":
                        console.log("Timed out");
                        break;
                    case "STANDBY": 
                        // No break
                    case "CONNECTING":
                        console.log("Elapsed:", elapsed, "Restarting in 2 seconds...");
                        setTimeout(function() {
                            update_terminal(status_url, elapsed + 2);
                        }, 2000);
                        break;
                    default:
                        console.log("Invalid state:", data['state']);
                        break;
                }
            });
        }

        // On click call update
        $("a#Play").bind("click",  function() { send_command_packet("PLAY");  });
        $("a#Pause").bind("click", function() { send_command_packet("PAUSE"); });
        $("a#Stop").bind("click",  function() { send_command_packet("STOP");  });
        $("a#Prev").bind("click",  function() { send_command_packet("PREV");  });
        $("a#Next").bind("click",  function() { read_diagnostic_packet(); });
        //{ send_command_packet("NEXT");  });

    </script>

</body>

</html>